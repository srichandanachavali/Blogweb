{% extends 'blog/base.html' %}
{% block title %}Home ‚Ä¢ Blogweb{% endblock %}

{% block content %}
<section class="feed">

  {% if stories or user.is_authenticated %}
  <div class="story-reel">
    
    <a href="{% url 'story_create' %}" class="story-circle-add">
      <div class="story-avatar-add">
        {% if user_profile and user_profile.image %}
          <img src="{{ user_profile.image.url }}" alt="Your profile">
        {% else %}
          <span>{{ user.username|first|upper }}</span>
        {% endif %}
        <div class="add-plus-icon">+</div>
      </div>
      <span class="story-username">Add Story</span>
    </a>

    {% for story in stories %}
      {% if story.author != request.user %} <a href="{% url 'story_view' username=story.author.username %}" class="story-circle">
        <div class="story-avatar">
          {% if story.author.profile and story.author.profile.image %}
            <img src="{{ story.author.profile.image.url }}" alt="{{ story.author.username }}">
          {% else %}
            <span>{{ story.author.username|first|upper }}</span>
          {% endif %}
        </div>
        <span class="story-username">{{ story.author.username }}</span>
      </a>
      {% endif %}
    {% endfor %}
  </div>
  {% endif %}
  {% if posts %}
  <div class="post-grid">
    {% for post in posts %}
    <article class="post-tile">
      <a class="post-tile__media" href="{% url 'post_detail' pk=post.pk %}">
        {% if post.image %}
        <img src="{{ post.image.url }}" alt="{{ post.title }}" />
        {% elif post.video %}
        <video src="{{ post.video.url }}" muted playsinline></video>
        {% else %}
        <div class="post-tile__placeholder">{{ post.title|first|upper }}</div>
        {% endif %}
        <span class="post-tile__badge">{{ post.publish|timesince }} ago</span>
      </a>
      <div class="post-tile__meta">
      <div class="post-tile__author">
        {% if post.author_profile and post.author_profile.image %}
        <img
          src="{{ post.author_profile.image.url }}"
          alt="{{ post.author.username }}"
        />
        {% else %}
        <span>{{ post.author.username|first|upper }}</span>
        {% endif %}
        <div>
          <a href="{% url 'public_profile' username=post.author.username %}"
            >{{ post.author.get_full_name|default:post.author.username }}</a
          >
          </div>
      </div>
        <h3>
          <a href="{% url 'post_detail' pk=post.pk %}">{{ post.title }}</a>
        </h3>
        <p>{{ post.body|striptags|truncatechars:110 }}</p>
        <div class="post-tile__tags">
          {% for tag in post.tags.all %}
          <span>#{{ tag }}</span>
          {% empty %}
          <span class="muted">No tags</span>
          {% endfor %}
        </div>
        <div class="post-tile__footer">
          <div class="post-tile__counts">
            <span>‚ù§Ô∏è {{ post.total_likes }}</span>
            <span>üí¨ {{ post.comments.all|length }}</span>
          </div>
          <div class="post-tile__actions">
            {% if user.is_authenticated %}
            <form
              action="{% url 'post_toggle_like' pk=post.pk %}"
              method="post"
            >
              {% csrf_token %}
              <input
                type="hidden"
                name="next"
                value="{{ request.get_full_path }}"
              />
              <button
                type="submit"
                class="post-tile__action {% if post.user_liked %}active{% endif %}"
              >
                ‚ù§Ô∏è
              </button>
            </form>
            <form
              action="{% url 'post_toggle_save' pk=post.pk %}"
              method="post"
            >
              {% csrf_token %}
              <input
                type="hidden"
                name="next"
                value="{{ request.get_full_path }}"
              />
              <button
                type="submit"
                class="post-tile__action {% if post.user_saved %}active{% endif %}"
              >
                üîñ
              </button>
            </form>
            {% else %}
            <a class="ghost-action" href="{% url 'login' %}">Log in to react</a>
            {% endif %}
          </div>
        </div>
      </div>
    </article>
    
    {% empty %} ¬†
    <p class="muted">No posts yet. Start the conversation!</p>

    {% endfor %} ¬† 
  </div>
  {% endif %}
</section>

<style>
.story-reel {
  display: flex;
  overflow-x: auto;
  padding: 10px 0 20px 0;
  gap: 15px;
  background: var(--card-bg);
  border-radius: 12px;
  margin-bottom: 1.5rem;
  padding-left: 15px;
  padding-right: 15px;
  /* Hides the scrollbar for a cleaner look */
  scrollbar-width: none; /* Firefox */
  -ms-overflow-style: none;  /* IE and Edge */
}
.story-reel::-webkit-scrollbar {
  display: none; /* Chrome, Safari, Opera */
}
.story-circle, .story-circle-add {
  display: flex;
  flex-direction: column;
  align-items: center;
  text-decoration: none;
  width: 70px;
  flex-shrink: 0;
}
.story-avatar, .story-avatar-add {
  width: 60px;
  height: 60px;
  border-radius: 50%;
  border: 2px solid var(--accent-color);
  padding: 2px;
  display: flex;
  align-items: center;
  justify-content: center;
  overflow: hidden;
  position: relative;
}
.story-avatar-add {
  border-style: dashed;
  border-color: #aaa;
}
.story-avatar img, .story-avatar-add img {
  width: 100%;
  height: 100%;
  object-fit: cover;
  border-radius: 50%;
}
.story-avatar span, .story-avatar-add span {
  font-weight: bold;
  font-size: 1.5rem;
  color: var(--text-color);
}
.story-username {
  font-size: 0.75rem;
  margin-top: 5px;
  color: var(--text-color);
  text-align: center;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  width: 100%;
}
.add-plus-icon {
  position: absolute;
  bottom: 0px;
  right: 0px;
  background: var(--accent-color);
  color: white;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  font-weight: bold;
  font-size: 1rem;
  border: 2px solid var(--card-bg, #fff);
}
</style>

{% endblock %}