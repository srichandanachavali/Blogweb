{% extends 'blog/base.html' %}

{% block title %}{{ post.title }}{% endblock %}

{% block content %}
<div class="comments-section">
    <div class="comment-form">
        {% if user.is_authenticated %}
            <h2>Add a new comment</h2>
            <p>You are commenting as {{ user.username }}.</p>
            <form method="post" id="comment-form">
                {{ form.as_p }}
                {% csrf_token %}
                <p><input type="submit" value="Add comment" /></p>
            </form>
        {% else %}
            <h2>Add a new comment</h2>
            <p>You must be <a href="{% url 'login' %}?next={{ request.path }}">logged in</a> to post a comment.</p>
            {% endif %}
        <div id="form-messages" style="margin-top: 10px;"></div>
    </div>
</div>

<a href="{% url 'post_list' %}">Back to post list</a>

{% if user.is_authenticated %}
<script>
    document.getElementById('comment-form').addEventListener('submit', function(e) {
        e.preventDefault();
        const form = this;
        const formData = new FormData(form);
        const url = form.action;

        // The name and email are no longer in the form, but that's okay!
        // The view handles adding them for authenticated users.

        fetch(url, {
            method: 'POST',
            headers: {
                'X-CSRFToken': formData.get('csrfmiddlewaretoken'),
                'X-Requested-With': 'XMLHttpRequest'
            },
            body: formData
        })
        .then(response => response.json())
        .then(data => {
            if (data.success) {
                const newComment = document.createElement('div');
                newComment.classList.add('comment');
                newComment.innerHTML = `
                  <p class="comment-meta">
                    Comment by <strong>${data.name}</strong> on ${data.created}
                  </p>
                  <div class="comment-body">${data.body.replace(/\n/g, '<br>')}</div>
                `;
                document.getElementById('comment-list').appendChild(newComment);
                const noComments = document.getElementById('no-comments');
                if (noComments) noComments.remove();
                form.reset();
                document.getElementById('form-messages').innerHTML = '<p style="color: green;">Comment added!</p>';
            } else {
                document.getElementById('form-messages').innerHTML = '<p style="color: red;">Something went wrong.</p>';
            }
        });
    });
</script>
{% endif %}
{% endblock %}