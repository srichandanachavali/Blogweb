{% extends 'blog/base.html' %} 
{% block title %}{{ post.title }} ‚Ä¢ Blogweb{% endblock %} 

{% block content %}
<article class="post-card post-card--detail">
  <header class="post-card__header">
    <div class="post-author-simple">
      <a
        href="{% url 'public_profile' username=post.author.username %}"
        class="post-author-avatar"
      >
        {% if post.author.profile and post.author.profile.image %}
        <img
          src="{{ post.author.profile.image.url }}"
          alt="{{ post.author.username }}"
        />
        {% else %}
        <span class="avatar-fallback"
          >{{ post.author.username|first|upper }}</span
        >
        {% endif %}
      </a>
      <div>
        <a
          href="{% url 'public_profile' username=post.author.username %}"
          class="post-author-name"
        >
          {{ post.author.get_full_name|default:post.author.username }}
        </a>
        <p class="post-author-handle">@{{ post.author.username }}</p>
      </div>
    </div>

    <h1>{{ post.title }}</h1>

    <div class="post-card__tags">
      {% for tag in post.tags.all %}
      <span>#{{ tag }}</span>
      {% empty %}
      <span class="muted">No tags yet</span>
      {% endfor %}
    </div>
  </header>

  {% if post.image %}
  <div class="post-card__media">
    <!-- ‚úÖ Use .url directly for Cloudinary -->
    <img
      src="{{ post.image.url }}"
      alt="{{ post.title }}"
      style="max-width: 100%; border-radius: 10px"
    />
  </div>
  {% elif post.video %}
  <div class="post-card__media">
    <video
      controls
      preload="metadata"
      style="max-width: 100%; border-radius: 10px"
    >
      <source src="{{ post.video.url }}" type="video/mp4" />
      Your browser does not support the video tag.
    </video>
  </div>
  {% endif %}

  <div class="post-card__body">{{ post.body|linebreaks }}</div>

  <footer class="post-card__footer">
    <div class="post-actions">
      <form action="{% url 'post_toggle_like' pk=post.pk %}" method="post">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.get_full_path }}" />
        <button
          type="submit"
          class="icon-button {% if post.user_liked %}active{% endif %}"
        >
          ‚ù§Ô∏è <span>{{ post.total_likes }}</span>
        </button>
      </form>
      <form action="{% url 'post_toggle_save' pk=post.pk %}" method="post">
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.get_full_path }}" />
        <button
          type="submit"
          class="icon-button {% if post.user_saved %}active{% endif %}"
        >
          üîñ <span>{{ post.total_saves }}</span>
        </button>
      </form>
    </div>

    <section class="comments">
      <h2>Comments</h2>

      {% for comment in comments %}
      <div class="comment">
        <a
          href="{% if comment.user %}{% url 'public_profile' username=comment.user.username %}{% else %}#{% endif %}"
          class="comment-avatar"
        >
          {% if comment.user and comment.user.profile.image %}
          <img
            src="{{ comment.user.profile.image.url }}"
            alt="{{ comment.user.username }}"
          />
          {% else %}
          <span class="avatar-fallback-comment"
            >{% if comment.user %}{{ comment.user.username|first|upper }}{% else
            %}A{% endif %}</span
          >
          {% endif %}
        </a>
        <div class="comment-content">
          <div class="comment__meta">
            <strong
              >{% if comment.user %}{{ comment.user.username }}{% else %}{{
              comment.name|default:'Anonymous' }}{% endif %}</strong
            >
            <span>{{ comment.created|timesince }} ago</span>
          </div>
          <p>{{ comment.body|linebreaksbr }}</p>
        </div>
      </div>
      {% empty %}
      <p class="muted">No comments yet. Start the discussion!</p>
      {% endfor %} {% if user.is_authenticated %}
      <form
        class="comment-form"
        method="post"
        action="{% url 'post_add_comment' pk=post.pk %}"
      >
        {% csrf_token %}
        <input type="hidden" name="next" value="{{ request.get_full_path }}" />
        <textarea
          name="body"
          rows="3"
          class="comment-input"
          placeholder="Share your thoughts‚Ä¶"
        ></textarea>
        <button type="submit" class="button">Post comment</button>
      </form>
      {% else %}
      <p class="muted">Log in to add a comment.</p>
      {% endif %}
    </section>
  </footer>
</article>

<style>
  .post-author-simple {
    display: flex;
    align-items: center;
    gap: 12px;
    margin-bottom: 16px;
  }

  .post-author-avatar {
    width: 45px;
    height: 45px;
    border-radius: 50%;
    overflow: hidden;
    background-color: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    flex-shrink: 0;
  }

  .post-author-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .post-author-avatar .avatar-fallback {
    font-size: 20px;
    font-weight: bold;
    color: #555;
  }

  .post-author-name {
    font-weight: 600;
    text-decoration: none;
    color: inherit;
    font-size: 1.1rem;
  }

  .post-author-handle {
    font-size: 0.9rem;
    color: #777;
    margin: 0;
  }

  .comment {
    display: flex;
    align-items: flex-start;
    gap: 12px;
    margin-bottom: 20px;
  }

  .comment-avatar {
    width: 38px;
    height: 38px;
    border-radius: 50%;
    overflow: hidden;
    background-color: #f0f0f0;
    display: flex;
    align-items: center;
    justify-content: center;
    text-decoration: none;
    flex-shrink: 0;
  }

  .comment-avatar img {
    width: 100%;
    height: 100%;
    object-fit: cover;
  }

  .comment-avatar .avatar-fallback-comment {
    font-size: 16px;
    font-weight: bold;
    color: #555;
  }

  .comment-content {
    flex: 1;
  }

  .comment-content p {
    margin: 4px 0 0 0;
    font-size: 0.95rem;
  }

  .comment__meta {
    font-size: 0.9rem;
  }

  .comment__meta strong {
    font-size: 0.95rem;
    color: #111;
  }

  .comment__meta span {
    color: #888;
    margin-left: 8px;
  }
</style>
{% endblock %}
